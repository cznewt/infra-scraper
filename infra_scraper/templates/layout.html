{% extends "base.html" %}

{% block page_header %}
Layout {{ name }}
{% endblock %}

{% block content %}
<div class="row">
  <div class="col s12 m9">
    <h6>Topology {{ name }}</h6>
    <div class="card">
      <div class="card-content">
        <div id="visual-layout-wrapper" class="{{ layout }}">
          <div id="visual-layout"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="col s12 m3">
    <h6>Topology Details</h6>
    <ul class="collection">
      <li class="collection-item">Endpoint<span class="badge">{{ name }}</span></li>
      <li class="collection-item">Dataset<span class="badge">{{ config.kind|capitalize }}</span></li>
      <li class="collection-item">Layout<span class="badge">{{ layout|capitalize }}</span></li>
      <li class="collection-item">Resources<span class="badge" id="countResources">N/A</span></li>
      <li class="collection-item">Relations<span class="badge" id="countRelations">N/A</span></li>
      <li class="collection-item">Scraped<span class="badge" id="timeAgo"></span></li>
    </ul>
    <h6>Resource Details</h6>
    <div id="resource-detail">
      <p>No resource selected.</p>
    <div>
  </div>
</div>
{% endblock %}

{% block content_actions %}
<div class="fixed-action-btn toolbar">
  <a class="btn-floating btn-large red">
    <i class="large material-icons">mode_edit</i>
  </a>
  <ul>
    <li class="waves-effect waves-light"><a href="./{{ layout }}">Update</a></li>
    <li class="waves-effect waves-light"><a href="/">Close</a></li>
  </ul>
</div>
{% endblock %}

{% block extra_js %}
<script>

var selector = '#visual-layout';

document.addEventListener("DOMContentLoaded", function(event) {
  console.log('DOM loaded.');
  var changeDetailBox = function (node) {
    var detailBoxTemplate = '<ul class="collection">' +
     '<li class="collection-item">Name<span class="badge">{name}</span></li>' +
     '<li class="collection-item">Kind<span class="badge">{kind}</span></li>' +
     '</ul>';
    $('#resource-detail').html(detailBoxTemplate.formatTemplate({
      name: node.name,
      kind: node.kind
    }));
  };
  {% if layout == 'hive' %}
  var dataSource = "/api/{{ name }}";
  d3.json(dataSource, function(data) {
    console.log(data);
    $("#countResources").html(Object.keys(data.resources).length);
    $("#countRelations").html(data.relations.length);
    $("#timeAgo").html("<time class='timeago' datetime='"+data.date+"'>N/A</time>");
    jQuery("time.timeago").timeago();
    HivePlot.init(selector, data, {nodeClickFn: changeDetailBox, selector: selector});
  });
  {% elif layout == 'edge-bundle' %}
  var dataSource = "/api/{{ name }}/hier";
  new RelationalPlot.hierarchicalEdgeBundling(dataSource, selector, 3600).init();
  {% elif layout == 'tree-map' %}
  var dataSource = "/api/{{ name }}/hier";
  new RelationalPlot.treeMap(dataSource, selector, 3600).init();
  {% endif %}
});

</script>
{% endblock %}
